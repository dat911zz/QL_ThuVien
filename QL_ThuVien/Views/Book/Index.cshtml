
@model IEnumerable<QL_ThuVien.DTO.SachDTO>
@{
    ViewBag.Title = "Sách";
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    bool isValidUser = QL_ThuVien.Intergrate.Services.Helper.SecurityHelper.HasPermission(HttpContext.Current);
}
<style>
    .dataTables_filter > label, .dataTables_length > label {
        font-size: 1rem;
    }

    table {
        border-collapse: collapse;
        table-layout: fixed;
        width: 310px;
    }
        .table th {
            text-align: center;
            vertical-align: middle;
        }
        .table td, .table th {
            white-space: normal !important;
        }
    .short-tent {
        text-overflow: ellipsis;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
        word-break: break-word;
        min-height: 3em;
    }
    a.btn.btn-secondary.btn-edit.m-l-0.px-075, a.btn.btn-danger.px-075 {
        padding-left: 0.75rem !important;
    }
    table.dataTable thead > tr > th {
        text-align: center;
        background-color: #333333;
        color: #ffffff;
    }
</style>
<body>
    <div class="test">
        <div class="header ml-0">
            <h2 class="position-relative" style="color: #440ccb ">DANH SÁCH TÀI LIỆU</h2>
            <hr class="bg-dark"></hr>
        </div>
    </div>
    <div style="float: right; margin-bottom: 10px;">
        <a href="@Url.Action("Create")" class="btn btn-success m-1">
            <span>
                <span><img src="https://img.icons8.com/office/22/null/add--v1.png" /></span> Thêm Sách
            </span>
        </a>
        <a href="@Url.Action("CreateFromFile")" class="btn btn-success m-1"><span><img src="https://img.icons8.com/doodle/22/null/microsoft-excel-2019.png" /></span> Thêm Từ File</a>
        <a href="@Url.Action("ExportFromFile")" class="btn btn-success m-1"><span><img src="https://img.icons8.com/arcade/22/null/print.png" /></span> Xuất File</a>
    </div>
    <div class="container">
        <div class="table">
            <table class="table" id="table_id" width="100%" cellspacing="0">
                <colgroup>
                    <col style="width: 15%;">
                    <col style="width: 8%;">
                    <col style="width: 15%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: auto;">
                    <col style="width: 12%">
                    @*<col style="width: 10%;">*@
                </colgroup>
                <thead>
                    <tr class="text-center">
                        <th>Ảnh Bìa</th>
                        <th>Mã Sách</th>
                        <th>Tên Sách</th>
                        <th>NXB</th>
                        <th>Chủ Đề</th>
                        <th>Năm Xuất Bản</th>
                        <th>Số lượng tồn</th>
                        @*<th>Mô Tả</th>*@
                        <th class="text-center">Công Cụ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td><img src="~/Assets/HinhAnhSP/@item.AnhBia" style="height: 10rem; width: 100%" alt="ANHBIA_@item.AnhBia" /></td>
                            <td class="text-center">@item.MaSach</td>
                            <td>
                                @item.TenSach
                            </td>
                            <td>@item.TenNXB</td>
                            <td>@item.TenChuDe</td>
                            <td class="text-center">@(item.NamXuatBan.ToShortDateString())</td>
                            @*<td class="text-center">@(item.GiaSach.ToString("#,###.##đ", new System.Globalization.CultureInfo("en-US", false).NumberFormat))</td>*@
                            <td class="slbs" sid="@item.MaSach">   
                                @Html.Raw(item.GetHtmlSLTon())
                            </td>
                            @*<td><div class="short-tent">@item.MoTa</div></td>*@
                            @if (isValidUser)
                            {
                                <td class="text-center">
                                    <a class="btn btn-primary btn-edit m-l-0 px-075" href="/Book/Detail/@item.MaSach" title="Thông tin chi tiết">
                                        <i class="fa fa-info" aria-hidden="true"></i>
                                    </a>
                                    <a class="btn btn-primary btn-edit m-l-0 px-075" href="/Book/BanSao/@item.MaSach" title="Bản sao sách">
                                        <i class="fa fa-file-text" aria-hidden="true"></i>
                                    </a>
                                    <a class="btn btn-primary btn-edit m-l-0 px-075" href="/Book/Edit/@item.MaSach" title="Chỉnh sửa thông tin">
                                        <i class="fa fa-pencil" aria-hidden="true"></i>
                                    </a>
                                    <a class="btn btn-danger btn-edit m-l-0 px-075 btn-liquidation-book" data-mas="@item.MaSach" data-dg="@item.GiaSach" title="Thanh Lý">
                                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                                    </a>
                                </td>
                            }
                            else
                            {
                                <td></td>
                            }
                        </tr>
                    }
                </tbody>
            </table>

        </div>

    </div>
</body>
<script>
    $(document).ready(function () {
        $(".btn-liquidation-book").click(function () {
            var mas = $(this).data('mas');
            var giaSach = $(this).data('dg');
            if (mas == '') {
                return;
            }
            var d = '@Html.Raw(DateTime.Now.ToString("dd/MM/yyyy"))';
            $('body').append(
                `
                    <div id="liquidation-s">
                        <div style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; z-index: 1000; background-color: rgba(0, 0, 0, 0.5); display:flex; align-items:center; justify-content:center;">
                            <div class="content" style="background-color:white; width:60%; border-radius:10px; padding:20px 40px;">
                                <div><h4 style="color:blue; text-transform: uppercase; text-align: center;">thanh lý sách</h4></div>
                                <div class="row">
                                    <div class="col-4">Mã sách</div>
                                    <div class="col-8 mas">${mas}</div>
                                </div>
                                <div class="row">
                                    <div class="col-4">Ngày thực hiện</div>
                                    <div class="col-8">${d}</div>
                                </div>
                                <div class="row">
                                    <div class="col-4">Đơn giá</div>
                                    <div class="col-8">
                                        <input class="don_gia form-control" type="number" min="1" max="1000000000" value="${giaSach}" />
                                    </div>
                                </div>
                                <div style="text-align: right; padding-right: 12px;"><div class="btn btn-primary">Thực hiện</div></div>
                            </div>
                        </div>
                        <style>
                            .content > div {
                                margin: 10px 0;
                            }
                        </style>
                    </div>
                `
            );
            addEventPopup();
        });
    });
    function addEventPopup() {
        $('#liquidation-s').click(function () {
            $(this).remove();
        });
        $('#liquidation-s .content').click(function (e) {
            e.stopPropagation();
        });
        $('#liquidation-s .btn').click(function () {
            let functionName = 'Thanh lý';
            let objectName = 'Sách';
            let id = $('#liquidation-s .mas').html();
            Swal.fire({
                icon: 'warning',
                title: 'Cảnh Báo!',
                html: '<div>Bạn có chắc muốn thực hiện hành động này?</div>'
                    + '<div>Chi tiết: <span style="font-weight: bold">' + functionName.toLowerCase() + ' ' + objectName.toLowerCase() + ' có mã là <span style="color: red">' + id + '</span></span></div>',
                showCancelButton: true,
                confirmButtonText: functionName,
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: '/Book/Delete',
                        data: {
                            id: id,
                            dongia: $('#liquidation-s input').val()
                        },
                        success: function (r) {
                            if (r == 'ok') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Thành Công',
                                    text: 'Đã ' + functionName.toLowerCase() + ' ' + objectName.toLowerCase() + ' có mã là ' + id + ' !',
                                    showConfirmButton: true,
                                    timer: 2000
                                }).then((result) => {
                                    location.reload();
                                });
                            }
                            else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Thất Bại',
                                    html: '<span style="font-weight: bold">Có lỗi đã xảy ra, vui lòng thử lại! <br/>Chi tiết: </span><span style="color: red;">' + r + '</span>',
                                    showConfirmButton: true,
                                    timer: 3500
                                })
                            }
                            if (reload) {
                                window.location.reload();
                            }
                        }
                    });
                }
            })
        });
    }
</script>

